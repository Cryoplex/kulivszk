<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, 
    user-scalable=no, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <!--<link rel="icon" href="../../favicon.ico">-->

    <title>Game</title>
    <style>
    .testSprite {
    	background: url(./spritest.png);
    	width: 24px;
    	height: 48px;
    	position: absolute;
    }
    #mycity {
    	position: relative;
    }
    </style>

    <link type="text/css" rel="stylesheet" href="../bootstrap.css">
    <link type="text/css" rel="stylesheet" href="stylesheet.css">
  </head>
  <body>
  	<div class="btn btn-default" onclick="expandCity(city, 'right')">Expand Right</div>
  	<div class="btn btn-default" onclick="expandCity(city, 'down')">Expand Down</div>
  	<hr>

  	<div id="mycity"></div>


  	<script src="../common.js"></script>
  	<script src="../jquery-2.1.4.min.js"></script>
  	<script src="../jquery-ui.min.js"></script>
    <script src="iso.js"></script>
  	<script>
  		var city = [[0]];
  		var pointer = {'x': 0, 'y': 0};
  		var squarelen = 7;
  		var seed = rand(1,1000000);
  		function expandCity(city, where) {
  			if (where == 'right') {
  				for (var c in city) city[c].push(0);
  			}
  			if (where == 'down') {
  				var arr = [];
  				for (var c in city[0]) arr.push(0);
  				city.push(arr);
  			}

  			displayCity(city);
  		}
  		function displayCity(city) {
  			var l = '';
  			for (var y in city) {
  				for (var x in city[y]) {
  					var top = y * 24;
  					var left = x * 24;
  					var wh = city[y][x] || 0;
  					l += '<tile class="testSprite" style="top: '+top+'px; left: '+left+'px; background-position: '+(wh * -24)+'px 0px"></tile>';

  				}
  			}

  			mycity.innerHTML = l;
  		}
  		function change(city, x, y, tile) {
  			city[y][x] = tile;
  			displayCity(city);
  		}
  		function builder() {
  			if (city != undefined && city[pointer.y] != undefined && city[pointer.y][pointer.x] != undefined && city[pointer.y][pointer.x] == 0) {
  				if (pointer.x % squarelen == 0 ||
  					pointer.y % squarelen == 0 ||
  					pointer.x % squarelen == (squarelen - 1) ||
  					pointer.y % squarelen == (squarelen - 1)) change(city, pointer.x, pointer.y, 11);

  				if ((pointer.x % squarelen == 1 ||
  					pointer.y % squarelen == 1 ||
  					pointer.x % squarelen == (squarelen - 2) ||
  					pointer.y % squarelen == (squarelen - 2)) &&
  					(pointer.x % squarelen != 0 &&
  					pointer.y % squarelen != 0 &&
  					pointer.x % squarelen != (squarelen - 1) &&
  					pointer.y % squarelen != (squarelen - 1))) change(city, pointer.x, pointer.y, 9);
  				if (pointer.x % squarelen > 1 &&
  					pointer.x % squarelen < (squarelen - 2) &&
  					pointer.y % squarelen > 1 &&
  					pointer.y % squarelen < (squarelen - 2)) {

  					 var builds = Number((seed + pointer.x + pointer.y) % 16).toString(2);
  					while(builds.length < 4) builds = '0'+builds;
  					if (builds == '1000' || builds == '0100' || builds == '0010' || builds == '0001') builds = '1111';

  					var px = (pointer.x % squarelen);
  					var py = (pointer.y % squarelen);
  					var b = builds.split('');

  					change(city, pointer.x, pointer.y, 99);
  					if ((px == 3 && py == 3 && builds != '0000') ||
  						(px == 3 && py == 2 && b[0] == 1) || 
  						(px == 2 && py == 3 && b[1] == 1) || 
  						(px == 4 && py == 3 && b[2] == 1) || 
  						(px == 3 && py == 4 && b[3] == 1)) change(city, pointer.x, pointer.y, 10);

  					if (px == 3 && py == 2 && b[0]) change(city, pointer.x, pointer.y, 10);



  				}
  			}

  			pointer.y++;
  			if (pointer.y > city.length) {
  				pointer.y = 0;
  				pointer.x++;
  			}
  			if (pointer.x > city[0].length) {
  				pointer.x = 0;
  				pointer.y = 0;
  			}
  		}

  		function buildinger() {
  			var ry = rand(1, city.length) - 1;
  			var rx = rand(1, city[0].length) - 1;

  			if (city[ry][rx] == 99) {
  				var b = rand(1,8);
  				change(city, rx, ry, b);
  				if (exists(city, rx-1, ry) == 99) change(city, rx-1, ry, b);
  				if (exists(city, rx+1, ry) == 99) change(city, rx+1, ry, b);
  				if (exists(city, rx, ry-1) == 99) change(city, rx, ry-1, b);
  				if (exists(city, rx, ry+1) == 99) change(city, rx, ry+1, b);
  			}
  		}
  		function exists(city, x, y) {
  			if (city == undefined) return false;
  			if (city[y] == undefined) return false;
  			if (city[y][x] == undefined) return false;
  			return city[y][x];
  		}

  		for (var x = 0; x < (squarelen * 2); x++) {
  			expandCity(city, 'right');
  			expandCity(city, 'down');
  		}
  		setInterval(builder, 10);

  		setInterval(buildinger, 100);
  	</script>
  </body>
</html>