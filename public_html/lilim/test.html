<!DOCTYPE html>
<html>
<head><title>Lilim</title>
<style>
.phrase {
	background-color: hsla(120, 80%, 80%, 0.8);
	padding: 8px;
	margin: 8px;
	border-radius: 8px;
	color: hsl(120, 80%, 20%);
	display: inline-block;
}
.answer {
	background-color: hsla(180, 80%, 80%, 0.8);
	padding: 4px;
	margin: 8px;
	border-radius: 1px;
	color: hsl(180, 80%, 20%);
	font-size: 10px;
	display: inline-block;
}
.delete {
	font-weight: bolder;
	color: black;
	cursor: pointer;
	padding: 4px;
	margin: 2px;
	border-radius: 8px;
	background-color: hsla(120, 80%, 80%, 0.5);
}
.delete:hover {
	color: red;
}
sup {
	font-size: 8px;
}
</style>
</head>
<body>
	<div id="perform"></div><hr>
	<div id="addswer"><input type="text" id="answerer"></div><hr>
	<div id="phrases"></div>
	<hr>
	<div id="allphrases"></div>

	<script src="jquery.js"></script>
	<script src="socket.js"></script>
	<script>
	var require = false;
	var app = false;
	var http = {
		'listen': function() {}
	}
	var lastUserData = '';
	var first = false;

	socket = io();
	socket.on('newMessage', function(msg) {
		log.innerHTML += 'MSG (' + msg.to + ') ('+msg.from+') '+msg.text+'<br>';
	});
	socket.on('database', function(dat) {
		database = dat;

		getPhrase(lastPhrase);
		//getPhrases();
	});
	socket.on('loginSucess', function() {
		login_phase2.style.display = 'none';
		login_phase1.style.display = 'none';
		loggingIn.style.display = 'none';
		localStorage.setItem('loginDetails', JSON.stringify(loginDetails));
	});
	socket.on('loginFailed', function() {
		loggingIn.style.display = 'none';
	});
	socket.on('serverMessage', function(dat) {
		notification(dat.message);
		console.log(dat.message);
	});
	socket.on('askUser', function(dat) {
		console.log('Yay finally got that user data back!');
		database.users[dat.username] = dat.data;
		if (dat.username == loginDetails.username) {
			displayMyData(dat.username);
		}
		else {
			displayUserData(dat.username);
		}
	});

	$(document).on('keypress', function(key) {
		//omg
		if (key.keyCode == 13) {
			var stuff = answerer.value;
			if (stuff) {
				console.log('Calling addAnswerz');
				addAnswerz(lastPhrase, stuff);
				console.log('Calling getPhrase');
				getPhrase(lastPhrase);
				answerer.value = '';
			}
			if (!stuff) {
				getPhrase();
			}
		}
	});

	var loginDetails = {'username': '','password': ''};
	var losto = localStorage.getItem('loginDetails');
	if (losto) {
		console.log('Found local storage data.');
		var log = JSON.parse(losto);
		console.log(log);
		if (log.username && log.password) reLogIn(log);
	}

	function reLogIn(log) {
		console.log('Trying to log in with data: ');
		console.log(log);
		if (!log.username || !log.password) return;
		loginDetails = log;

		loggingIn.style.display = 'block';

		setTimeout(function() {
			socket.emit('password', {
				'username': log.username,
				'password': log.password,
			})
		}, 2000);
	}
	function rand(minimum,maximum) {
		var randie = Math.floor(Math.random() * (maximum - minimum + 1)) + minimum;
		if (randie < minimum) randie = minimum;
		if (randie > maximum) randie = maximum;
		return randie;
	}
	function anotherDrawBar(min, max, color) {

	}
	function askUserData(username) {
		userData.innerHTML = 'Cargando...';
		socket.emit('askUser', {'username': username});
	}
	function logIn() {
		loginDetails.password = '';
		var us = nickSelect.value;
		loginDetails.username = us;

		var pwd = passwordSelect.value;
		if (pwd) {
			loginDetails.password = pwd;
			socket.emit('password', {'username': us, 'password': pwd});
			return;
		}
		socket.emit('password', {'username': us});
		login_phase1.style.display = 'none';
		login_phase2.style.display = 'block';
	}
	function displayPoints(user) {
		return '<small>'+user.points+' puntos<br>'+user.statPoints+' <abbr title="Puntos de Habilidad">PH</abbr></small>';
	}
	function displayUserData(name) {
		lastUserData = name;
		
		var dud = '';
		var uzer = database.users[name];
		dud += '<div class="userData_1" style="height: 3em"><b class="userData_1a">'+displayFullName(name)+'</b><br><i class="userData_1b">'+displayPoints(uzer)+'</i></div>';

		dud += '<div class="userData_1" style="height: 5em">';
		dud += 'Nivel '+uzer.level+'<br>';
		dud += getBar(name, 'experience', 'EXP');
		dud += getBar(name, 'baseHP', 'VIDA');
		dud += getBar(name, 'baseMP', 'MAGIA');
		dud += '</div>';

		dud += '<div class="userData_1">';
		dud += shortm(getStatsFord(name, 'baseATK'))+' Ataque<br>';
		dud += shortm(getStatsFord(name, 'baseDEF'))+' Defensa<br>';
		dud += shortm(getStatsFord(name, 'baseSPD'))+' Velocidad<br>';
		dud += '</div>';

		dud += '<div class="userData_1" style="font-size: 0.5em">';
		var equips = ['leftHand', 'rightHand', 'head', 'armor', 'feet', 'amulet'];
		for (var e in equips) {
			var it = uzer.equipment[equips[e]];
			dud += '<small>'+equipmentSlots[e].name+'</small> '+displayItem2(it, true)+'<br>';
		}
		dud += '</div>';

		dud += '<input type="button" class="botButton" onclick="atac()" value="Atacar">';


		userData.style.opacity = 1;
		userData.innerHTML = dud;
	}
	function displayMyData(name) {
		var dud = '';
		var uzer = database.users[name];
		dud += '<div class="userName"><b>'+displayFullName(name)+'</b><br>'+displayPoints(uzer)+'</div>';

		dud += '<div class="userStats">';
		dud += shortm(getStatsFord(name, 'baseATK'))+' Ataque<br>';
		dud += shortm(getStatsFord(name, 'baseDEF'))+' Defensa<br>';
		dud += shortm(getStatsFord(name, 'baseSPD'))+' Velocidad<br>';
		dud += '</div>';

		dud += '<div class="userEquip">';
		var equips = ['leftHand', 'rightHand', 'head', 'armor', 'feet', 'amulet'];
		for (var e in equips) {
			var it = uzer.equipment[equips[e]];
			dud += '<small>'+equipmentSlots[e].name+'</small> '+displayItem2(it, true)+'<br>';
		}
		dud += '</div>';

		dud += '<div class="bars">';
		dud += 'Nivel '+uzer.level+'<br>';
		dud += getBar(name, 'experience', 'EXP');
		dud += getBar(name, 'baseHP', 'VIDA');
		dud += getBar(name, 'baseMP', 'MAGIA');

		dud += '</div>';

		myUserData.innerHTML = dud;
	}
	function getBar(name, data, after) {
		var user = database.users[name];
		var obj = {
			'experience': {
				'min': user.experience,
				'max': expForNextLevel(user.level),
				'bgc': 'rgb(255, 200, 48)',
				'extra': '(x'+user.expMod+')',
			},
			'baseHP': {
				'min': user.actualHP,
				'max': getStatsFor(name, 'baseHP'),
				'bgc': 'rgb(96, 255, 96)',
				'extra': '',
			},
			'baseMP': {
				'min': user.actualMP,
				'max': getStatsFor(name, 'baseMP'),
				'bgc': 'rgb(96, 0, 192)',
				'extra': '',
			}
		}
		var min = obj[data].min;
		var max = obj[data].max;
		var bgc = obj[data].bgc;
		var extra = obj[data].extra;

		var percent = (min / max) * 15;
		var percentMax = 15 - percent;

		var bar = '<div class="bar" title="'+min+'/'+max+' '+after+' '+extra+'"><div class="barLeft" style="background-color: '+bgc+'; width: '+percent+'em"></div><div class="barRight" style="width: '+percentMax+'em"></div></div><small class="break">'+after+'</small>';

		return bar

	}
	function displayFullName(nick) {
		var user = database.users[nick];
		var name = (user.name) ? user.name : nick;
		var n = name+'<br><i>'+getClass(user)+' '+getAlignment(user)+'</i>';
		return n;
	}
	function displayPhrase(index, answer) {
		var ph = database.phrasebook[index];
		var cl = 'phrase'
		if (answer) {
			var ph = database.answers[index][answer];
			cl = 'answer';
		}

		var element = '';
		element += '<span class="'+cl+'">';
		element += '<span class="delete" onclick="this.parentElement.style.display = \'none\';">o</span>';
		element += '<span class="delete" ';
		if (answer != undefined) {
			element += 'onclick="deleteAnswer('+index+', '+answer+')';
		}
		else {
			element += 'onclick="deletePhrase('+index+')';
		}
		element += '; this.parentElement.style.display = \'none\'">x</span> <sup>#'+index+'/'+database.phrasebook.length+'</sup> '+ph+'</span>';

		return element;
	}
	var performance = {'checked': 0, 'deleted': 0};
	function deletePhrase(index) {
		performance.deleted++;
		socket.emit('delPhrase', {
			'questionID': index,
		});
		lastPhrase = undefined;
	}
	function deleteAnswer(index, answer) {
		socket.emit('delAnswer', {
			'questionID': index,
			'answerID': answer,
		});
	}

	function addAnswerz(index, answer) {
		console.log('Will add answer '+answer+' to id '+index);
		socket.emit('addAnswer', {
			'questionID': index,
			'answer': answer,
		});
	}
	var lastPhrase;
	function getPhrases() {
		var l = '';
		for (var p in database.phrasebook) {
			l += displayPhrase(p);
		}
		phrases.innerHTML = l;
	}
	function getPhrase(index) {
		performance.checked++;

		//Check first with no answers
		var r = rand(0, database.phrasebook.length-1);


		if (index && index >= 0) r = index;
		lastPhrase = r;

		phrases.innerHTML = displayPhrase(r);
		perform.innerHTML = performance.deleted +'/'+performance.checked+' ('+(((performance.checked - performance.deleted) / performance.checked) * 100)+'% pass)';

		var answers = database.answers[r];

		phrases.innerHTML += '<hr>';
		for (var a in answers) {
			phrases.innerHTML += displayPhrase(r, a)+'<br>';
		}
	}
	function read(array) {
		var max = array.length-1;
		var min = rand(0,max);
		return array[min];
	}
	</script>
	<script src="client.js"></script>
	<script src="common.js"></script>
	<script src="jquery.min.js"></script>
	<script src="jquery-ui.min.js"></script>
</body>
</html>